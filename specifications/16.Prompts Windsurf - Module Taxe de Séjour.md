# Prompts Windsurf - Module Taxe de S√©jour

## Vue d'Ensemble du Module

Le module Taxe de S√©jour est un composant sp√©cialis√© du Backoffice de l'ERP Wedding Collection, con√ßu pour g√©rer l'ensemble du processus de collecte, d√©claration et reversement de la taxe de s√©jour dans le cadre de l'activit√© d'h√©bergement touristique. Ce module r√©pond aux exigences l√©gales et r√©glementaires fran√ßaises concernant la taxe de s√©jour, tout en s'int√©grant harmonieusement dans l'√©cosyst√®me global de l'ERP.

### Architecture Technique

- **Sch√©ma de donn√©es** : `bo_taxe_sejour` avec 8 tables principales
- **Int√©grations** : Modules √âv√©nement, Lieu, Comptabilit√©, Client Portal
- **Conformit√©** : Articles L2333-26 √† L2333-47 du CGCT
- **Technologies** : Next.js 14+, Supabase, TypeScript, Tailwind CSS, ShadCN UI

---

## Section 1 : Initialisation

### Prompt 1.1 : Cr√©ation du Sch√©ma de Base de Donn√©es Taxe de S√©jour

üéØ **But** : Cr√©er le sch√©ma de base de donn√©es complet pour la gestion de la taxe de s√©jour avec conformit√© r√©glementaire fran√ßaise

üß† **Contexte** : Impl√©mentation du sch√©ma `bo_taxe_sejour` dans Supabase avec 8 tables principales, ENUMs sp√©cialis√©s, politiques RLS granulaires, et triggers pour automatisation des calculs fiscaux selon la r√©glementation fran√ßaise.

üõ†Ô∏è **Fichiers** :
- `supabase/migrations/[timestamp]_create_taxe_sejour_schema.sql`
- `supabase/migrations/[timestamp]_create_taxe_sejour_functions.sql`
- `supabase/migrations/[timestamp]_create_taxe_sejour_triggers.sql`
- `supabase/migrations/[timestamp]_create_taxe_sejour_rls.sql`

üîÑ **Comportement** :
Cr√©er le sch√©ma `bo_taxe_sejour` avec les tables principales : `ts_communes` (configuration des communes avec param√®tres sp√©cifiques), `ts_tarifs` (tarifs par cat√©gorie d'h√©bergement et p√©riode avec historisation), `ts_calculs` (r√©sultats des calculs de taxe pour chaque s√©jour), `ts_exonerations` (gestion des exon√©rations et justificatifs), `ts_declarations` (d√©clarations p√©riodiques aux collectivit√©s), `ts_reversements` (suivi des paiements aux collectivit√©s), `ts_templates` (mod√®les de documents), `ts_audit` (tra√ßabilit√© compl√®te).

Impl√©menter les ENUMs sp√©cialis√©s : `taxe_mode_calcul` (reel, forfaitaire, proportionnel), `taxe_statut_declaration` (brouillon, validee, soumise, acceptee), `taxe_type_exoneration` (mineur, saisonnier, urgence, autre), `taxe_statut_reversement` (attente, paye, retard).

Cr√©er les fonctions PostgreSQL : `calculate_taxe_sejour()` pour calcul automatique selon r√©glementation, `apply_exonerations()` pour gestion des exon√©rations, `generate_declaration()` pour pr√©paration des d√©clarations, `validate_tarifs()` pour contr√¥le de coh√©rence.

Impl√©menter les triggers : d√©clenchement automatique du calcul lors de cr√©ation/modification de r√©servation, mise √† jour des statuts de d√©claration, archivage automatique des donn√©es, audit trail complet.

Configurer les politiques RLS : acc√®s granulaire par organisation et r√¥le, isolation des donn√©es fiscales, permissions sp√©cifiques pour auditeurs et collectivit√©s.

‚öôÔ∏è **Interactions** :
- **R√©f√©rence** : Tables `shared.venues` pour localisation des h√©bergements
- **Int√®gre** : Module √âv√©nement via `events.bookings` pour r√©servations
- **Synchronise** : Module Comptabilit√© pour √©critures automatiques
- **S√©curise** : Donn√©es fiscales avec chiffrement et audit trail

üí° **Tips Windsurf** :
- Utiliser Supabase CLI pour migrations avec `supabase db diff`
- Impl√©menter contraintes CHECK pour validation des montants
- Cr√©er index composites pour optimisation des requ√™tes de consolidation
- Utiliser SECURITY DEFINER pour fonctions de calcul sensibles
- Tester migrations avec donn√©es de test r√©glementaires

### Prompt 1.2 : G√©n√©ration des Types TypeScript et Validation Zod

üéØ **But** : G√©n√©rer les types TypeScript complets et les sch√©mas de validation Zod pour toutes les entit√©s du module Taxe de S√©jour

üß† **Contexte** : Cr√©ation des types TypeScript dans `packages/shared/src/types/taxe-sejour.ts` avec validation Zod stricte pour garantir la conformit√© des donn√©es fiscales et l'int√©grit√© des calculs.

üõ†Ô∏è **Fichiers** :
- `packages/shared/src/types/taxe-sejour.ts`
- `packages/shared/src/schemas/taxe-sejour.ts`
- `packages/shared/src/utils/taxe-sejour-helpers.ts`
- `packages/shared/src/constants/taxe-sejour.ts`

üîÑ **Comportement** :
G√©n√©rer les types TypeScript pour toutes les tables : `TsCommune`, `TsTarif`, `TsCalcul`, `TsExoneration`, `TsDeclaration`, `TsReversement`, `TsTemplate`, `TsAudit` avec propri√©t√©s compl√®tes et relations typ√©es.

Cr√©er les types d'union pour ENUMs : `TaxeModeCalcul`, `TaxeStatutDeclaration`, `TaxeTypeExoneration`, `TaxeStatutReversement` avec valeurs exactes.

Impl√©menter les sch√©mas Zod avec validation stricte : montants positifs, dates coh√©rentes, r√©f√©rences valides, formats r√©glementaires (SIRET, codes commune), validation des p√©riodes tarifaires.

D√©velopper les types de requ√™te et r√©ponse API : `CreateTarifRequest`, `CalculTaxeResponse`, `DeclarationSummary`, `ReversementStatus` avec validation compl√®te.

Cr√©er les helpers utilitaires : `calculateTaxeAmount()`, `validateExoneration()`, `formatDeclarationNumber()`, `checkTarifValidity()` avec logique m√©tier encapsul√©e.

D√©finir les constantes r√©glementaires : taux de taxe additionnelle (10%), plafonds pour h√©bergements non class√©s, dur√©es de conservation l√©gales (10 ans), codes d'exon√©ration officiels.

‚öôÔ∏è **Interactions** :
- **√âtend** : Types de base de `shared/types/common.ts`
- **R√©f√©rence** : Types Venue et Event pour int√©grations
- **Utilise** : Validation Zod pour s√©curit√© des donn√©es fiscales
- **Exporte** : Types vers modules Comptabilit√© et √âv√©nement

üí° **Tips Windsurf** :
- Utiliser `satisfies` pour typage strict des constantes
- Impl√©menter validation custom Zod pour r√®gles m√©tier complexes
- Cr√©er types discriminated unions pour statuts avec transitions
- Utiliser `z.transform()` pour normalisation des donn√©es
- Documenter types avec JSDoc pour conformit√© r√©glementaire

### Prompt 1.3 : Architecture des Services Backend et Edge Functions

üéØ **But** : Cr√©er l'architecture des services backend avec Edge Functions Supabase pour la logique m√©tier complexe de la taxe de s√©jour

üß† **Contexte** : Impl√©mentation des services backend dans `supabase/functions/` avec Edge Functions pour calculs fiscaux, int√©grations externes, et g√©n√©ration de documents r√©glementaires.

üõ†Ô∏è **Fichiers** :
- `supabase/functions/taxe-sejour-calculator/index.ts`
- `supabase/functions/taxe-sejour-declarations/index.ts`
- `supabase/functions/taxe-sejour-exports/index.ts`
- `supabase/functions/taxe-sejour-integrations/index.ts`
- `supabase/functions/_shared/taxe-sejour-utils.ts`

üîÑ **Comportement** :
D√©velopper `taxe-sejour-calculator` avec calcul intelligent : d√©termination automatique du mode de calcul (r√©el, forfaitaire, proportionnel), gestion des s√©jours √† cheval sur plusieurs p√©riodes, application des plafonnements pour h√©bergements non class√©s, calcul de la taxe additionnelle d√©partementale, validation des exon√©rations avec justificatifs.

Cr√©er `taxe-sejour-declarations` avec g√©n√©ration automatique : pr√©paration des d√©clarations p√©riodiques selon formats r√©glementaires, consolidation des donn√©es par commune et p√©riode, g√©n√©ration du registre du logeur conforme, validation des montants et coh√©rence, workflow de soumission avec tra√ßabilit√©.

Impl√©menter `taxe-sejour-exports` avec formats multiples : export des d√©clarations en PDF r√©glementaire, g√©n√©ration Excel pour analyses, export CSV pour logiciels comptables, cr√©ation de codes QR pour tra√ßabilit√©, archivage s√©curis√© des documents.

D√©velopper `taxe-sejour-integrations` avec connecteurs externes : int√©gration plateformes de t√©l√©d√©claration (OCSITAN), synchronisation avec logiciels comptables, import de donn√©es depuis plateformes de r√©servation, r√©conciliation automatique des donn√©es.

Cr√©er les utilitaires partag√©s : validation des donn√©es fiscales, formatage des montants selon r√©glementation, gestion des erreurs avec codes sp√©cifiques, logging s√©curis√© pour audit, helpers de calcul r√©glementaire.

‚öôÔ∏è **Interactions** :
- **Calcule** : Taxes selon r√©glementation fran√ßaise en vigueur
- **Int√®gre** : Plateformes externes via APIs s√©curis√©es
- **G√©n√®re** : Documents conformes aux exigences l√©gales
- **Synchronise** : Donn√©es avec modules Comptabilit√© et √âv√©nement

üí° **Tips Windsurf** :
- Utiliser Deno pour Edge Functions avec imports ESM
- Impl√©menter retry logic pour int√©grations externes
- Cr√©er middleware de validation pour s√©curit√© fiscale
- Utiliser streaming pour exports volumineux
- Tester fonctions avec donn√©es r√©glementaires r√©elles

### Prompt 1.4 : Configuration des Hooks et Contextes React

üéØ **But** : Configurer les hooks React et contextes pour la gestion d'√©tat du module Taxe de S√©jour avec optimisation des performances

üß† **Contexte** : Cr√©ation des hooks sp√©cialis√©s dans `apps/backoffice/src/hooks/taxe-sejour/` et contextes React pour gestion d'√©tat optimis√©e avec cache intelligent et synchronisation temps r√©el.

üõ†Ô∏è **Fichiers** :
- `apps/backoffice/src/hooks/taxe-sejour/useTaxeSejourCalculator.ts`
- `apps/backoffice/src/hooks/taxe-sejour/useTaxeSejourDeclarations.ts`
- `apps/backoffice/src/hooks/taxe-sejour/useTaxeSejourReversements.ts`
- `apps/backoffice/src/contexts/TaxeSejourContext.tsx`
- `apps/backoffice/src/providers/TaxeSejourProvider.tsx`

üîÑ **Comportement** :
Cr√©er `useTaxeSejourCalculator` avec calcul optimis√© : calcul automatique avec debouncing, cache des r√©sultats par r√©servation, invalidation intelligente lors de modifications, gestion des erreurs de calcul, preview en temps r√©el des montants.

D√©velopper `useTaxeSejourDeclarations` avec workflow complet : pr√©paration assist√©e des d√©clarations, validation multi-√©tapes, suivi des statuts avec transitions, g√©n√©ration de documents, soumission avec retry automatique.

Impl√©menter `useTaxeSejourReversements` avec suivi financier : calcul des montants √† reverser, gestion des √©ch√©ances avec alertes, rapprochement avec paiements effectu√©s, g√©n√©ration des √©critures comptables, historique des reversements.

Cr√©er `TaxeSejourContext` avec √©tat global : configuration des communes et tarifs, cache des calculs r√©cents, statuts des d√©clarations en cours, notifications et alertes, pr√©f√©rences utilisateur.

D√©velopper `TaxeSejourProvider` avec optimisations : lazy loading des donn√©es volumineuses, synchronisation Supabase Realtime, persistence locale pour mode hors ligne, gestion des conflits de donn√©es, cleanup automatique du cache.

‚öôÔ∏è **Interactions** :
- **Synchronise** : √âtat avec Supabase Realtime pour mises √† jour
- **Cache** : R√©sultats de calculs pour optimisation performance
- **Notifie** : Changements d'√©tat aux composants abonn√©s
- **Persiste** : Donn√©es critiques en local storage s√©curis√©

üí° **Tips Windsurf** :
- Utiliser React Query pour cache et synchronisation
- Impl√©menter optimistic updates pour UX fluide
- Cr√©er custom hooks avec TypeScript strict
- Utiliser useCallback et useMemo pour optimisation
- Tester hooks avec React Testing Library

---

## Section 2 : Fonctionnalit√©s Principales

### Prompt 2.1 : Dashboard Taxe de S√©jour avec KPIs R√©glementaires

üéØ **But** : D√©velopper le dashboard principal du module Taxe de S√©jour avec indicateurs cl√©s de performance et conformit√© r√©glementaire

üß† **Contexte** : Interface de pilotage dans `apps/backoffice/src/app/taxe-sejour/page.tsx` avec m√©triques temps r√©el, alertes de conformit√©, et visualisations sp√©cialis√©es pour la gestion fiscale.

üõ†Ô∏è **Fichiers** :
- `apps/backoffice/src/app/taxe-sejour/page.tsx`
- `apps/backoffice/src/app/taxe-sejour/components/TaxeSejourDashboard.tsx`
- `apps/backoffice/src/app/taxe-sejour/components/KPICards.tsx`
- `apps/backoffice/src/app/taxe-sejour/components/DeclarationStatus.tsx`
- `apps/backoffice/src/app/taxe-sejour/components/RevenueChart.tsx`

üîÑ **Comportement** :
Cr√©er `TaxeSejourDashboard` avec vue d'ensemble : KPIs principaux (montant collect√© p√©riode, taux de conformit√©, d√©clarations en attente, reversements dus), alertes prioritaires avec codes couleur, graphiques d'√©volution des collectes, calendrier des √©ch√©ances r√©glementaires, acc√®s rapide aux actions critiques.

D√©velopper `KPICards` avec m√©triques sp√©cialis√©es : montant total collect√© avec comparaison p√©riode pr√©c√©dente, nombre de s√©jours tax√©s avec taux d'exon√©ration, d√©clarations soumises vs en retard, reversements effectu√©s vs dus, indicateurs de conformit√© r√©glementaire.

Impl√©menter `DeclarationStatus` avec suivi temps r√©el : statut des d√©clarations par commune et p√©riode, workflow de validation avec √©tapes, alertes d'√©ch√©ances approchantes, boutons d'action contextuels, historique des soumissions.

Cr√©er `RevenueChart` avec analyses visuelles : √©volution des collectes par mois et commune, r√©partition par type d'h√©bergement, comparaison avec pr√©visions, impact des exon√©rations, tendances saisonni√®res.

Int√©grer navigation contextuelle : acc√®s direct aux fonctionnalit√©s selon statut, filtres intelligents par p√©riode et commune, recherche rapide par num√©ro de d√©claration, export des donn√©es affich√©es.

‚öôÔ∏è **Interactions** :
- **Agr√®ge** : Donn√©es de toutes les tables du module
- **Synchronise** : M√©triques temps r√©el via Supabase Realtime
- **Navigue** : Vers fonctionnalit√©s sp√©cialis√©es selon contexte
- **Alerte** : Utilisateurs sur √©ch√©ances et non-conformit√©s

üí° **Tips Windsurf** :
- Utiliser Recharts pour visualisations performantes
- Impl√©menter lazy loading pour m√©triques complexes
- Cr√©er composants r√©utilisables pour KPIs
- Utiliser React.memo pour optimisation re-renders
- Tester accessibilit√© avec screen readers

### Prompt 2.2 : Interface de Configuration des Communes et Tarifs

üéØ **But** : Cr√©er l'interface compl√®te de configuration des communes et gestion des tarifs avec validation r√©glementaire

üß† **Contexte** : Module de configuration dans `apps/backoffice/src/app/taxe-sejour/configuration` avec gestion des communes, tarifs par cat√©gorie, p√©riodes sp√©ciales, et validation de conformit√©.

üõ†Ô∏è **Fichiers** :
- `apps/backoffice/src/app/taxe-sejour/configuration/page.tsx`
- `apps/backoffice/src/app/taxe-sejour/configuration/components/CommuneManager.tsx`
- `apps/backoffice/src/app/taxe-sejour/configuration/components/TarifManager.tsx`
- `apps/backoffice/src/app/taxe-sejour/configuration/components/PeriodeSpecialeForm.tsx`
- `apps/backoffice/src/app/taxe-sejour/configuration/components/ValidationReglementaire.tsx`

üîÑ **Comportement** :
D√©velopper `CommuneManager` avec gestion compl√®te : liste des communes avec recherche et filtres, formulaire de cr√©ation/modification avec validation, configuration des param√®tres sp√©cifiques (mode de calcul, taxe additionnelle, p√©riodes de collecte), gestion des quartiers et zones sp√©ciales, import en masse depuis fichiers officiels.

Cr√©er `TarifManager` avec flexibilit√© maximale : grille de tarifs par cat√©gorie d'h√©bergement et p√©riode, historisation automatique des modifications, validation des montants selon plafonds r√©glementaires, gestion des tarifs saisonniers avec calendrier, preview des impacts sur calculs existants.

Impl√©menter `PeriodeSpecialeForm` avec gestion √©v√©nementielle : d√©finition de p√©riodes avec tarifs sp√©ciaux, gestion des chevauchements avec validation, application automatique selon dates, exceptions pour √©v√©nements locaux, coordination avec calendrier des d√©clarations.

D√©velopper `ValidationReglementaire` avec contr√¥les automatiques : v√©rification de conformit√© des tarifs avec bar√®mes officiels, validation des codes commune et SIRET, contr√¥le des p√©riodes de collecte, alertes sur modifications impactantes, g√©n√©ration de rapports de conformit√©.

Int√©grer workflow d'approbation : validation multi-niveaux pour modifications sensibles, tra√ßabilit√© compl√®te des changements, notifications aux utilisateurs concern√©s, rollback s√©curis√© en cas d'erreur, synchronisation avec d√©clarations en cours.

‚öôÔ∏è **Interactions** :
- **Valide** : Conformit√© avec r√©glementation fran√ßaise
- **Synchronise** : Modifications avec calculs existants
- **Notifie** : √âquipes des changements impactants
- **Archive** : Historique pour audit et tra√ßabilit√©

üí° **Tips Windsurf** :
- Utiliser React Hook Form pour validation complexe
- Impl√©menter debouncing pour validation temps r√©el
- Cr√©er composants de saisie sp√©cialis√©s (montants, dates)
- Utiliser optimistic updates avec rollback
- Tester validation avec cas limites r√©glementaires

### Prompt 2.3 : Syst√®me de Calcul et Collecte Automatique

üéØ **But** : Impl√©menter le syst√®me de calcul automatique et de collecte de la taxe de s√©jour avec gestion des cas complexes

üß† **Contexte** : Module de calcul dans `apps/backoffice/src/app/taxe-sejour/calculs` avec algorithmes de calcul selon r√©glementation, gestion des exon√©rations, et interface de suivi des collectes.

üõ†Ô∏è **Fichiers** :
- `apps/backoffice/src/app/taxe-sejour/calculs/page.tsx`
- `apps/backoffice/src/app/taxe-sejour/calculs/components/CalculEngine.tsx`
- `apps/backoffice/src/app/taxe-sejour/calculs/components/ExonerationManager.tsx`
- `apps/backoffice/src/app/taxe-sejour/calculs/components/CollecteTracker.tsx`
- `apps/backoffice/src/app/taxe-sejour/calculs/components/RecalculBatch.tsx`

üîÑ **Comportement** :
Cr√©er `CalculEngine` avec logique r√©glementaire : calcul automatique selon mode (r√©el, forfaitaire, proportionnel), gestion des s√©jours multi-p√©riodes avec pro-rata, application des plafonnements pour h√©bergements non class√©s, calcul de la taxe additionnelle d√©partementale, validation des montants avec alertes d'anomalie.

D√©velopper `ExonerationManager` avec workflow complet : saisie des exon√©rations avec justificatifs, validation automatique des crit√®res d'√©ligibilit√©, upload et stockage s√©curis√© des pi√®ces, workflow d'approbation multi-niveaux, historique et tra√ßabilit√© des d√©cisions.

Impl√©menter `CollecteTracker` avec suivi d√©taill√© : liste des taxes calcul√©es avec statuts de collecte, filtres avanc√©s par p√©riode et commune, indicateurs de performance de collecte, gestion des impay√©s avec relances, rapprochement avec encaissements.

Cr√©er `RecalculBatch` avec traitement en masse : recalcul automatique suite √† modifications tarifaires, traitement par lots avec progress tracking, validation des impacts avant application, rollback s√©curis√© en cas d'erreur, notification des utilisateurs concern√©s.

Int√©grer monitoring et alertes : d√©tection d'anomalies de calcul, alertes sur montants aberrants, suivi des performances de calcul, logs d√©taill√©s pour audit, m√©triques de qualit√© des donn√©es.

‚öôÔ∏è **Interactions** :
- **Calcule** : Taxes selon r√©servations du module √âv√©nement
- **Applique** : Tarifs configur√©s par commune et p√©riode
- **G√®re** : Exon√©rations avec validation r√©glementaire
- **Synchronise** : Collectes avec module Comptabilit√©

üí° **Tips Windsurf** :
- Utiliser Web Workers pour calculs intensifs
- Impl√©menter cache intelligent pour optimisation
- Cr√©er algorithmes de validation robustes
- Utiliser transactions pour coh√©rence des donn√©es
- Tester avec jeux de donn√©es r√©glementaires

### Prompt 2.4 : Module de D√©clarations et Reversements

üéØ **But** : D√©velopper le module complet de gestion des d√©clarations p√©riodiques et des reversements aux collectivit√©s

üß† **Contexte** : Interface de d√©clarations dans `apps/backoffice/src/app/taxe-sejour/declarations` avec assistant de pr√©paration, g√©n√©ration de documents r√©glementaires, et suivi des reversements.

üõ†Ô∏è **Fichiers** :
- `apps/backoffice/src/app/taxe-sejour/declarations/page.tsx`
- `apps/backoffice/src/app/taxe-sejour/declarations/components/DeclarationWizard.tsx`
- `apps/backoffice/src/app/taxe-sejour/declarations/components/DocumentGenerator.tsx`
- `apps/backoffice/src/app/taxe-sejour/declarations/components/ReversementManager.tsx`
- `apps/backoffice/src/app/taxe-sejour/declarations/components/TeleDecleration.tsx`

üîÑ **Comportement** :
Cr√©er `DeclarationWizard` avec assistant guid√© : s√©lection de la p√©riode et commune, consolidation automatique des donn√©es, validation de coh√©rence avec contr√¥les r√©glementaires, preview de la d√©claration avec possibilit√© de corrections, workflow de validation multi-√©tapes avec approbations.

D√©velopper `DocumentGenerator` avec formats officiels : g√©n√©ration du registre du logeur conforme, cr√©ation de l'√©tat r√©capitulatif r√©glementaire, export PDF avec mise en page officielle, g√©n√©ration de codes QR pour tra√ßabilit√©, archivage automatique avec horodatage.

Impl√©menter `ReversementManager` avec suivi financier : calcul automatique des montants √† reverser, gestion du calendrier des √©ch√©ances, g√©n√©ration des ordres de virement, rapprochement avec paiements effectu√©s, gestion des p√©nalit√©s de retard.

Cr√©er `TeleDecleration` avec int√©grations externes : connexion s√©curis√©e aux plateformes officielles (OCSITAN), transmission automatique des d√©clarations, suivi des accus√©s de r√©ception, gestion des erreurs et rejets, retry automatique avec backoff.

Int√©grer workflow de validation : contr√¥les de coh√©rence automatiques, validation par responsable fiscal, tra√ßabilit√© compl√®te des modifications, notifications d'√©ch√©ances, archivage s√©curis√© pour audit.

‚öôÔ∏è **Interactions** :
- **Consolide** : Donn√©es de calculs pour d√©clarations
- **G√©n√®re** : Documents conformes aux formats officiels
- **Transmet** : D√©clarations aux plateformes r√©glementaires
- **Synchronise** : Reversements avec module Comptabilit√©

üí° **Tips Windsurf** :
- Utiliser PDF-lib pour g√©n√©ration de documents
- Impl√©menter validation stricte des formats officiels
- Cr√©er syst√®me de retry robuste pour t√©l√©d√©clarations
- Utiliser chiffrement pour donn√©es sensibles
- Tester avec environnements de test officiels

---

## Section 3 : Fonctionnalit√©s Secondaires

### Prompt 3.1 : Reporting et Analytics Avanc√©s

üéØ **But** : Cr√©er le syst√®me de reporting et d'analytics avanc√©s pour l'analyse des donn√©es de taxe de s√©jour

üß† **Contexte** : Module de reporting dans `apps/backoffice/src/app/taxe-sejour/reporting` avec g√©n√©ration de rapports personnalisables, analyses pr√©dictives, et visualisations interactives.

üõ†Ô∏è **Fichiers** :
- `apps/backoffice/src/app/taxe-sejour/reporting/page.tsx`
- `apps/backoffice/src/app/taxe-sejour/reporting/components/ReportBuilder.tsx`
- `apps/backoffice/src/app/taxe-sejour/reporting/components/AnalyticsCharts.tsx`
- `apps/backoffice/src/app/taxe-sejour/reporting/components/PredictiveAnalysis.tsx`
- `apps/backoffice/src/app/taxe-sejour/reporting/components/ExportManager.tsx`

üîÑ **Comportement** :
D√©velopper `ReportBuilder` avec personnalisation compl√®te : s√©lection de m√©triques et dimensions, filtres avanc√©s par p√©riode et g√©ographie, groupements et agr√©gations configurables, templates de rapports pr√©d√©finis, sauvegarde et partage de configurations.

Cr√©er `AnalyticsCharts` avec visualisations interactives : √©volution des collectes avec tendances, r√©partition par type d'h√©bergement et commune, analyse des exon√©rations avec impacts, comparaisons inter-p√©riodes, drill-down dans les donn√©es d√©taill√©es.

Impl√©menter `PredictiveAnalysis` avec mod√®les pr√©dictifs : pr√©visions de collecte bas√©es sur historique, d√©tection d'anomalies avec alertes, analyse de saisonnalit√© avec recommandations, simulation d'impact de changements tarifaires, benchmarking avec donn√©es sectorielles.

D√©velopper `ExportManager` avec formats multiples : export Excel avec graphiques int√©gr√©s, PDF avec mise en page professionnelle, CSV pour analyses externes, API pour int√©grations tierces, planification d'exports automatiques.

Int√©grer fonctionnalit√©s avanc√©es : alertes sur seuils configurables, abonnements aux rapports avec envoi automatique, collaboration avec commentaires et annotations, historique des consultations pour audit, cache intelligent pour performance.

‚öôÔ∏è **Interactions** :
- **Analyse** : Donn√©es consolid√©es de tous les modules
- **Pr√©dit** : Tendances bas√©es sur historique et saisonnalit√©
- **Compare** : Performances avec benchmarks sectoriels
- **Exporte** : Rapports vers syst√®mes externes

üí° **Tips Windsurf** :
- Utiliser D3.js pour visualisations complexes
- Impl√©menter lazy loading pour gros volumes de donn√©es
- Cr√©er syst√®me de cache pour requ√™tes co√ªteuses
- Utiliser Web Workers pour calculs pr√©dictifs
- Tester performance avec datasets r√©alistes

### Prompt 3.2 : Gestion des Int√©grations et Connecteurs

üéØ **But** : D√©velopper le syst√®me de gestion des int√©grations avec plateformes externes et connecteurs sp√©cialis√©s

üß† **Contexte** : Module d'int√©grations dans `apps/backoffice/src/app/taxe-sejour/integrations` avec connecteurs pour plateformes de r√©servation, logiciels comptables, et services de t√©l√©d√©claration.

üõ†Ô∏è **Fichiers** :
- `apps/backoffice/src/app/taxe-sejour/integrations/page.tsx`
- `apps/backoffice/src/app/taxe-sejour/integrations/components/ConnectorManager.tsx`
- `apps/backoffice/src/app/taxe-sejour/integrations/components/DataSyncMonitor.tsx`
- `apps/backoffice/src/app/taxe-sejour/integrations/components/MappingConfiguration.tsx`
- `apps/backoffice/src/app/taxe-sejour/integrations/components/ErrorResolution.tsx`

üîÑ **Comportement** :
Cr√©er `ConnectorManager` avec gestion centralis√©e : catalogue de connecteurs disponibles (Airbnb, Booking, Sage, Cegid), configuration des authentifications s√©curis√©es, activation/d√©sactivation avec tests de connexion, monitoring des statuts en temps r√©el, gestion des versions et mises √† jour.

D√©velopper `DataSyncMonitor` avec suivi d√©taill√© : statut des synchronisations par connecteur, logs d√©taill√©s des √©changes de donn√©es, m√©triques de performance et fiabilit√©, alertes sur √©checs ou anomalies, historique des synchronisations avec possibilit√© de rejeu.

Impl√©menter `MappingConfiguration` avec flexibilit√© maximale : mapping des champs entre syst√®mes, transformation des donn√©es avec r√®gles personnalisables, validation des mappings avec tests, gestion des formats de dates et devises, preview des transformations avant application.

Cr√©er `ErrorResolution` avec gestion proactive : d√©tection automatique des erreurs de synchronisation, classification par type et gravit√©, suggestions de r√©solution automatique, workflow de traitement manuel, escalade vers support technique.

Int√©grer fonctionnalit√©s avanc√©es : r√©conciliation automatique des donn√©es, d√©tection de doublons avec r√©solution, audit trail complet des √©changes, chiffrement des donn√©es sensibles, retry intelligent avec backoff.

‚öôÔ∏è **Interactions** :
- **Synchronise** : Donn√©es avec plateformes de r√©servation externes
- **Exporte** : Vers logiciels comptables et fiscaux
- **Importe** : Tarifs et configurations depuis sources officielles
- **Transmet** : D√©clarations vers plateformes r√©glementaires

üí° **Tips Windsurf** :
- Utiliser pattern Adapter pour connecteurs
- Impl√©menter circuit breaker pour r√©silience
- Cr√©er syst√®me de queue pour traitement asynchrone
- Utiliser webhook pour notifications temps r√©el
- Tester int√©grations avec environnements sandbox

### Prompt 3.3 : Audit et Conformit√© R√©glementaire

üéØ **But** : Impl√©menter le syst√®me complet d'audit et de conformit√© r√©glementaire pour la taxe de s√©jour

üß† **Contexte** : Module d'audit dans `apps/backoffice/src/app/taxe-sejour/audit` avec tra√ßabilit√© compl√®te, contr√¥les de conformit√©, et pr√©paration aux contr√¥les fiscaux.

üõ†Ô∏è **Fichiers** :
- `apps/backoffice/src/app/taxe-sejour/audit/page.tsx`
- `apps/backoffice/src/app/taxe-sejour/audit/components/AuditTrail.tsx`
- `apps/backoffice/src/app/taxe-sejour/audit/components/ComplianceChecker.tsx`
- `apps/backoffice/src/app/taxe-sejour/audit/components/DocumentArchive.tsx`
- `apps/backoffice/src/app/taxe-sejour/audit/components/ControlPreparation.tsx`

üîÑ **Comportement** :
D√©velopper `AuditTrail` avec tra√ßabilit√© exhaustive : historique complet de toutes les modifications, identification des utilisateurs et horodatage, d√©tail des valeurs avant/apr√®s modification, contexte des changements avec justifications, recherche avanc√©e dans l'historique.

Cr√©er `ComplianceChecker` avec contr√¥les automatiques : v√©rification de conformit√© avec r√©glementation en vigueur, validation des tarifs selon bar√®mes officiels, contr√¥le des d√©lais de d√©claration et reversement, d√©tection d'anomalies avec scoring de risque, g√©n√©ration de rapports de conformit√©.

Impl√©menter `DocumentArchive` avec gestion s√©curis√©e : archivage automatique des documents r√©glementaires, conservation selon dur√©es l√©gales (10 ans), indexation pour recherche rapide, chiffrement et contr√¥le d'acc√®s, export s√©curis√© pour contr√¥les externes.

D√©velopper `ControlPreparation` avec assistance compl√®te : pr√©paration des dossiers pour contr√¥les fiscaux, g√©n√©ration automatique des pi√®ces justificatives, synth√®se des d√©clarations par p√©riode, calcul des √©carts et r√©gularisations, simulation de redressements.

Int√©grer fonctionnalit√©s de s√©curit√© : signature √©lectronique des documents critiques, horodatage certifi√© pour tra√ßabilit√©, sauvegarde chiffr√©e avec redondance, contr√¥le d'int√©grit√© des donn√©es, logs s√©curis√©s non modifiables.

‚öôÔ∏è **Interactions** :
- **Trace** : Toutes les op√©rations sur donn√©es fiscales
- **Contr√¥le** : Conformit√© avec r√©glementation fran√ßaise
- **Archive** : Documents selon exigences l√©gales
- **Pr√©pare** : Dossiers pour contr√¥les fiscaux

üí° **Tips Windsurf** :
- Utiliser triggers PostgreSQL pour audit automatique
- Impl√©menter signature √©lectronique avec certificats
- Cr√©er syst√®me de r√©tention automatique
- Utiliser chiffrement AES-256 pour archivage
- Tester conformit√© avec r√©f√©rentiels officiels

---

## Section 4 : √âvolutions Futures

### Prompt 4.1 : Intelligence Artificielle et Automatisation Avanc√©e

üéØ **But** : Int√©grer l'intelligence artificielle pour l'automatisation avanc√©e et l'optimisation de la gestion de la taxe de s√©jour

üß† **Contexte** : Module IA dans `apps/backoffice/src/app/taxe-sejour/ai` utilisant machine learning pour pr√©dictions, d√©tection d'anomalies, et optimisation automatique des processus fiscaux.

üõ†Ô∏è **Fichiers** :
- `apps/backoffice/src/app/taxe-sejour/ai/page.tsx`
- `apps/backoffice/src/app/taxe-sejour/ai/components/PredictiveModels.tsx`
- `apps/backoffice/src/app/taxe-sejour/ai/components/AnomalyDetection.tsx`
- `apps/backoffice/src/app/taxe-sejour/ai/components/AutomationEngine.tsx`
- `supabase/functions/ai-taxe-sejour-predictor/index.ts`

üîÑ **Comportement** :
Cr√©er `PredictiveModels` avec mod√®les avanc√©s : pr√©diction des collectes bas√©e sur historique et √©v√©nements locaux, anticipation des besoins de tr√©sorerie, pr√©vision des pics de d√©clarations, mod√©lisation de l'impact des changements tarifaires, recommandations d'optimisation fiscale.

D√©velopper `AnomalyDetection` avec IA sp√©cialis√©e : d√©tection automatique d'anomalies dans les calculs, identification de patterns suspects dans les exon√©rations, alerte sur variations inhabituelles de collecte, scoring de risque pour contr√¥les cibl√©s, apprentissage continu des patterns normaux.

Impl√©menter `AutomationEngine` avec orchestration intelligente : automatisation compl√®te des d√©clarations r√©currentes, optimisation des calendriers de reversement, g√©n√©ration automatique de courriers de relance, adaptation dynamique aux changements r√©glementaires, workflow intelligent de validation.

Cr√©er l'Edge Function `ai-taxe-sejour-predictor` : mod√®les de machine learning pour pr√©dictions, API de scoring des risques, traitement en temps r√©el des donn√©es, int√©gration avec services cloud AI, cache intelligent des pr√©dictions.

Int√©grer fonctionnalit√©s avanc√©es : traitement du langage naturel pour analyse r√©glementaire, vision par ordinateur pour validation de justificatifs, chatbot sp√©cialis√© pour assistance utilisateur, recommandations personnalis√©es par profil, apprentissage f√©d√©r√© pour am√©lioration continue.

‚öôÔ∏è **Interactions** :
- **Pr√©dit** : Tendances et besoins futurs avec pr√©cision
- **D√©tecte** : Anomalies et risques automatiquement
- **Optimise** : Processus selon patterns appris
- **Recommande** : Actions bas√©es sur analyse pr√©dictive

üí° **Tips Windsurf** :
- Utiliser TensorFlow.js pour mod√®les c√¥t√© client
- Impl√©menter pipeline MLOps pour d√©ploiement continu
- Cr√©er datasets d'entra√Ænement avec donn√©es anonymis√©es
- Utiliser AutoML pour optimisation des mod√®les
- Tester pr√©dictions avec validation crois√©e

### Prompt 4.2 : √âcosyst√®me d'Int√©gration et API Publique

üéØ **But** : Cr√©er un √©cosyst√®me d'int√©gration complet avec API publique pour la taxe de s√©jour et marketplace de connecteurs

üß† **Contexte** : Plateforme d'int√©gration dans `apps/backoffice/src/app/taxe-sejour/ecosystem` avec API publique document√©e, SDK d√©veloppeur, et marketplace de connecteurs tiers.

üõ†Ô∏è **Fichiers** :
- `apps/backoffice/src/app/taxe-sejour/ecosystem/page.tsx`
- `apps/backoffice/src/app/taxe-sejour/ecosystem/components/APIManager.tsx`
- `apps/backoffice/src/app/taxe-sejour/ecosystem/components/ConnectorMarketplace.tsx`
- `apps/backoffice/src/app/taxe-sejour/ecosystem/components/DeveloperPortal.tsx`
- `packages/taxe-sejour-sdk/src/index.ts`
- `docs/api/taxe-sejour/openapi.yaml`

üîÑ **Comportement** :
D√©velopper `APIManager` avec gestion compl√®te : documentation interactive avec exemples, authentification avec tokens s√©curis√©s, rate limiting avec quotas flexibles, monitoring avec m√©triques d√©taill√©es, versioning avec compatibilit√© ascendante, sandbox pour tests d√©veloppeurs.

Cr√©er `ConnectorMarketplace` avec √©cosyst√®me ouvert : catalogue de connecteurs certifi√©s, installation en un clic avec configuration guid√©e, √©valuations et reviews communautaires, support d√©veloppeur avec documentation, certification avec programme partenaire.

Impl√©menter `DeveloperPortal` avec outils complets : documentation technique exhaustive, exemples de code multi-langages, outils de test avec environnement sandbox, support communautaire avec forums, certification d√©veloppeur avec badges.

D√©velopper le SDK `taxe-sejour-sdk` : biblioth√®ques JavaScript/TypeScript, Python, PHP avec m√©thodes simplifi√©es, gestion automatique de l'authentification, retry et error handling int√©gr√©s, types TypeScript pour d√©veloppement s√ªr, exemples d'usage complets.

Cr√©er l'API publique avec OpenAPI : endpoints RESTful pour toutes les fonctionnalit√©s, webhooks pour notifications temps r√©el, GraphQL pour requ√™tes flexibles, authentification OAuth 2.0, documentation auto-g√©n√©r√©e.

‚öôÔ∏è **Interactions** :
- **Expose** : API publique avec documentation compl√®te
- **Connecte** : Syst√®mes tiers via connecteurs certifi√©s
- **Facilite** : D√©veloppement avec SDK et outils
- **S√©curise** : Acc√®s avec authentification robuste

üí° **Tips Windsurf** :
- Utiliser OpenAPI 3.0 pour documentation automatique
- Impl√©menter rate limiting avec Redis
- Cr√©er SDK avec g√©n√©ration automatique
- Utiliser webhook pour notifications temps r√©el
- Tester API avec environnements de test complets

### Prompt 4.3 : Blockchain et Certification Num√©rique

üéØ **But** : Int√©grer la technologie blockchain pour la certification num√©rique et la tra√ßabilit√© immuable des d√©clarations fiscales

üß† **Contexte** : Module blockchain dans `apps/backoffice/src/app/taxe-sejour/blockchain` utilisant la blockchain pour certification des d√©clarations, smart contracts pour automatisation, et NFT pour tra√ßabilit√©.

üõ†Ô∏è **Fichiers** :
- `apps/backoffice/src/app/taxe-sejour/blockchain/page.tsx`
- `apps/backoffice/src/app/taxe-sejour/blockchain/components/CertificationManager.tsx`
- `apps/backoffice/src/app/taxe-sejour/blockchain/components/SmartContractInterface.tsx`
- `apps/backoffice/src/app/taxe-sejour/blockchain/components/NFTTracker.tsx`
- `packages/blockchain-taxe-sejour/src/contracts/TaxeSejourCertification.sol`

üîÑ **Comportement** :
Cr√©er `CertificationManager` avec blockchain native : certification immuable des d√©clarations sur blockchain publique, horodatage cryptographique avec preuve de non-r√©pudiation, v√©rification de l'int√©grit√© avec hash SHA-256, audit trail distribu√© et transparent, interop√©rabilit√© avec syst√®mes gouvernementaux.

D√©velopper `SmartContractInterface` avec automatisation : smart contracts pour automatisation des reversements, conditions programmables pour d√©clenchement automatique, escrow d√©centralis√© pour s√©curisation des fonds, gouvernance d√©centralis√©e pour √©volutions r√©glementaires, oracles pour donn√©es externes fiables.

Impl√©menter `NFTTracker` avec tra√ßabilit√© unique : NFT pour chaque d√©claration avec m√©tadonn√©es compl√®tes, marketplace pour √©change de certificats, royalties automatiques pour cr√©ateurs de valeur, gamification avec r√©compenses pour conformit√©, collection num√©rique pour historique fiscal.

Cr√©er le smart contract `TaxeSejourCertification` : contrat Solidity pour certification des d√©clarations, fonctions de validation avec consensus, √©mission automatique de certificats NFT, int√©gration avec oracles pour donn√©es officielles, gouvernance avec DAO pour √©volutions.

Int√©grer √©cosyst√®me Web3 : wallet integration pour authentification d√©centralis√©e, IPFS pour stockage distribu√© des documents, DeFi pour optimisation de tr√©sorerie, DAO pour gouvernance communautaire, interop√©rabilit√© cross-chain.

‚öôÔ∏è **Interactions** :
- **Certifie** : D√©clarations avec blockchain immuable
- **Automatise** : Processus via smart contracts
- **Trace** : Documents avec NFT uniques
- **S√©curise** : Donn√©es avec cryptographie avanc√©e

üí° **Tips Windsurf** :
- Utiliser Ethereum ou Polygon pour smart contracts
- Impl√©menter IPFS pour stockage d√©centralis√©
- Cr√©er interface Web3 avec ethers.js
- Utiliser Chainlink pour oracles fiables
- Tester contracts avec Hardhat et tests unitaires

---

## Validation et Coh√©rence Inter-Modules

### Validation Technique

**Conformit√© Supabase** : Toutes les sp√©cifications respectent les conventions Wedding Collection avec sch√©ma `bo_taxe_sejour` isol√©, politiques RLS granulaires, et int√©gration harmonieuse avec les modules existants.

**Architecture Modulaire** : Le module Taxe de S√©jour s'int√®gre parfaitement avec l'√©cosyst√®me ERP existant tout en maintenant son autonomie fonctionnelle et sa sp√©cialisation fiscale.

**Conformit√© R√©glementaire** : L'architecture propos√©e respecte strictement la r√©glementation fran√ßaise (CGCT articles L2333-26 √† L2333-47) avec validation continue de conformit√©.

### Int√©grations Valid√©es

**Module √âv√©nement** : Calcul automatique de la taxe lors de cr√©ation/modification de r√©servations avec synchronisation temps r√©el et gestion des annulations.

**Module Lieu** : Utilisation des donn√©es de localisation et classement pour d√©termination automatique des tarifs applicables selon commune et cat√©gorie.

**Module Comptabilit√©** : G√©n√©ration automatique des √©critures comptables pour collectes et reversements avec synchronisation des p√©riodes comptables.

**Client Portal** : Affichage transparent des montants de taxe dans devis/factures avec collecte des justificatifs d'exon√©ration.

### Recommandations d'Impl√©mentation

1. **Commencer par l'Initialisation** : Ex√©cuter les 4 premiers prompts dans l'ordre strict pour √©tablir les fondations r√©glementaires
2. **Prioriser la Conformit√©** : Valider chaque fonctionnalit√© avec la r√©glementation fran√ßaise en vigueur
3. **Tester avec Donn√©es R√©elles** : Utiliser des jeux de donn√©es conformes aux cas d'usage r√©glementaires
4. **Former les Utilisateurs** : Pr√©voir formation approfondie sur les aspects fiscaux et r√©glementaires
5. **Maintenir la Veille R√©glementaire** : Surveiller les √©volutions l√©gales pour adaptations n√©cessaires

Le module Taxe de S√©jour est maintenant pr√™t pour un d√©veloppement efficace avec Windsurf, offrant une solution compl√®te et conforme pour la gestion fiscale sp√©cialis√©e ! üéØ

