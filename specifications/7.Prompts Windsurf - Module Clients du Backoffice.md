# Prompts Windsurf - Module Clients du Backoffice

**Version :** 1.0  
**Date :** 3 Juin 2025  
**Auteur :** Manus AI - Expert Windsurf  
**Module :** 1.4 Back Office Clients  
**Application :** apps/backoffice  

---

## 📋 Vue d'Ensemble du Module

Le module **Clients du Backoffice** constitue le cœur de la gestion client de l'ERP Wedding Collection. Il gère l'ensemble du cycle de vie client depuis la conversion des leads qualifiés jusqu'à la gestion complète des relations client avec profils détaillés, historique des événements, documents, interactions et intégrations avec tous les modules de l'écosystème.

### 🎯 Objectifs Principaux
- **Gestion complète des fiches clients** (particuliers et entreprises)
- **Conversion automatisée** des leads qualifiés en clients actifs
- **Système de documents** avec stockage sécurisé et catégorisation
- **Historique des interactions** avec suivi complet des communications
- **Champs personnalisés** pour adaptation aux besoins spécifiques
- **Intégration Client-Portal** avec synchronisation bidirectionnelle
- **Conformité RGPD** avec gestion des consentements

### 🏗️ Architecture Technique
- **Schéma shared** : 8 tables principales avec relations complexes
- **Types énumérés** : Standardisation des valeurs métier
- **RLS granulaire** : Sécurité fine selon rôles et organisations
- **Fonctions RPC** : API backend optimisée pour performance
- **Storage Supabase** : Gestion sécurisée des documents clients
- **Intégration Realtime** : Synchronisation temps réel avec Client-Portal

### 🔗 Intégrations Critiques
- **Module Leads** : Conversion automatisée des prospects qualifiés
- **Module Événements** : Liaison avec les événements clients
- **Console Admin** : Permissions et audit des actions sensibles
- **Client-Portal** : Synchronisation bidirectionnelle des données
- **Dashboard** : Métriques et KPIs clients en temps réel

---

## 🏗️ Section 1 : Initialisation

### 01 - Création du schéma de base de données clients

🎯 **But :** Créer l'architecture complète de base de données pour la gestion des clients avec toutes les tables, relations et contraintes nécessaires.

🧠 **Contexte technique :** Le module Clients utilise le schéma `shared` pour permettre l'accès transversal par tous les modules. L'architecture supporte les clients particuliers et entreprises, avec gestion des conjoints, adresses multiples, documents et champs personnalisés.

🛠️ **Type de fichier :** `.sql` (migration Supabase)

🔄 **Comportement attendu :**
Créer dans l'ordre les tables suivantes avec leurs contraintes et index :
- `shared.clients` : Table principale avec informations client principal et conjoint
- `shared.client_addresses` : Adresses multiples (facturation, livraison, autre)
- `shared.client_documents` : Métadonnées des documents avec liens Storage
- `shared.client_interactions` : Historique complet des interactions
- `shared.custom_field_definitions` : Définitions des champs personnalisés
- `shared.client_custom_fields` : Valeurs des champs personnalisés par client
- `shared.client_history` : Audit détaillé des modifications sensibles
- `shared.client_pending_changes` : Modifications en attente depuis Client-Portal

Implémenter les contraintes d'intégrité référentielle, les index de performance et les contraintes métier (unicité email par organisation, validation formats, etc.).

⚙️ **Interactions :** 
- Référence `bo.leads(id)` pour la conversion
- Référence `shared.organizations(id)` pour l'isolation multi-tenant
- Référence `auth.users(id)` pour l'accès Client-Portal
- Référence `shared.user_profiles(id)` pour l'audit des actions

💡 **Tips Windsurf :** Utilise le MCP Supabase pour créer directement les migrations. Assure-toi de respecter l'ordre de création des tables selon les dépendances. Teste les contraintes avec des données d'exemple.

---

### 02 - Création des types énumérés et listes de valeurs

🎯 **But :** Définir tous les types énumérés et listes de valeurs standardisées utilisées par le module Clients pour assurer la cohérence des données.

🧠 **Contexte technique :** Le système utilise la table `shared.list_options` pour centraliser toutes les listes de valeurs. Cette approche permet la modification dynamique des options sans migration de base de données.

🛠️ **Type de fichier :** `.sql` (migration Supabase)

🔄 **Comportement attendu :**
Insérer dans `shared.list_options` toutes les valeurs pour :
- `civility` : M., Mme, Dr., etc.
- `client_type` : Particulier, Entreprise, Association, etc.
- `client_source` : Site web, Recommandation, Salon, Réseaux sociaux, etc.
- `language` : Français, Anglais, Espagnol, etc.
- `country` : Liste complète des pays avec codes ISO
- `client_document_type` : Contrat, Pièce d'identité, Brief, Facture, etc.

Créer la fonction `shared.check_list_option(option_id UUID, list_name TEXT)` pour valider les références aux listes de valeurs.

⚙️ **Interactions :** 
- Utilisé par toutes les tables avec des champs de type liste
- Partagé avec d'autres modules pour cohérence globale
- Accessible depuis le Client-Portal pour les formulaires

💡 **Tips Windsurf :** Groupe les insertions par `list_name` pour une meilleure lisibilité. Utilise des `display_order` logiques pour l'affichage frontend. Prévois l'extensibilité avec `is_active` pour désactiver sans supprimer.

---

### 03 - Création des index de performance

🎯 **But :** Optimiser les performances des requêtes fréquentes sur les données clients avec des index stratégiquement placés.

🧠 **Contexte technique :** Les recherches clients sont intensives (nom, email, entreprise) et les jointures avec les tables liées sont fréquentes. Les index doivent couvrir les cas d'usage principaux sans impacter les performances d'écriture.

🛠️ **Type de fichier :** `.sql` (migration Supabase)

🔄 **Comportement attendu :**
Créer les index suivants :
- `idx_clients_email_org` : Recherche par email dans une organisation
- `idx_clients_name_org` : Recherche par nom dans une organisation
- `idx_clients_active_deleted` : Filtrage clients actifs/supprimés
- `idx_clients_created_at` : Tri chronologique
- `idx_clients_company_name` : Recherche entreprises (avec condition WHERE)
- `idx_client_addresses_client_id` : Jointures adresses
- `idx_client_documents_client_id` : Jointures documents
- `idx_client_interactions_client_id` : Jointures interactions
- `idx_client_interactions_date` : Tri chronologique interactions
- `idx_client_custom_fields_client` : Jointures champs personnalisés

⚙️ **Interactions :** 
- Optimise les requêtes des fonctions RPC
- Améliore les performances de recherche frontend
- Accélère les jointures avec modules liés (Événements, Facturation)

💡 **Tips Windsurf :** Utilise `EXPLAIN ANALYZE` pour valider l'efficacité des index. Privilégie les index composites pour les requêtes multi-critères. Surveille la taille des index vs bénéfice performance.

---

### 04 - Implémentation des politiques RLS (Row Level Security)

🎯 **But :** Sécuriser l'accès aux données clients avec des politiques RLS granulaires selon les rôles et l'isolation multi-tenant.

🧠 **Contexte technique :** Chaque organisation doit accéder uniquement à ses clients. Les rôles déterminent les permissions (lecture, écriture, suppression). Le Client-Portal a des accès restreints à ses propres données.

🛠️ **Type de fichier :** `.sql` (migration Supabase)

🔄 **Comportement attendu :**
Activer RLS sur toutes les tables et créer les politiques :

**Pour `shared.clients` :**
- `clients_select_policy` : Lecture selon organisation et rôle
- `clients_insert_policy` : Création par rôles autorisés
- `clients_update_policy` : Modification selon rôle et propriété
- `clients_delete_policy` : Suppression logique par administrateurs

**Pour tables liées :**
- Politiques similaires avec vérification de l'`organization_id`
- Accès Client-Portal limité aux données du client connecté
- Audit trail protégé en lecture seule pour non-administrateurs

Utiliser les fonctions d'aide comme `shared.get_user_organization_id()` et `shared.user_has_permission()`.

⚙️ **Interactions :** 
- Intégration avec Console Admin pour vérification des permissions
- Coordination avec auth.users pour l'authentification Client-Portal
- Respect de l'isolation multi-tenant

💡 **Tips Windsurf :** Teste chaque politique avec différents rôles. Utilise des fonctions helper pour éviter la duplication de logique. Documente clairement les permissions pour chaque rôle.

---

### 05 - Création des fonctions RPC backend

🎯 **But :** Implémenter l'API backend complète avec toutes les fonctions RPC nécessaires pour les opérations CRUD et la logique métier complexe.

🧠 **Contexte technique :** Les fonctions RPC encapsulent la logique métier complexe côté base de données pour optimiser les performances et centraliser les règles business. Elles gèrent les transactions, validations et calculs.

🛠️ **Type de fichier :** `.sql` (fonctions PostgreSQL)

🔄 **Comportement attendu :**
Créer les fonctions RPC suivantes :

**Gestion CRUD :**
- `shared.rpc_get_clients_list(params JSONB)` : Liste paginée avec filtres et recherche
- `shared.rpc_get_client_details(client_id UUID)` : Détails complets avec données liées
- `shared.rpc_create_client(client_data JSONB)` : Création avec validation et audit
- `shared.rpc_update_client(client_id UUID, client_data JSONB)` : Mise à jour avec historique
- `shared.rpc_soft_delete_client(client_id UUID)` : Suppression logique sécurisée

**Fonctions spécialisées :**
- `shared.rpc_convert_lead_to_client(lead_id UUID)` : Conversion automatisée
- `shared.rpc_get_client_documents(client_id UUID)` : Documents avec métadonnées
- `shared.rpc_add_client_interaction(interaction_data JSONB)` : Ajout interaction
- `shared.rpc_get_client_similarity(search_params JSONB)` : Détection doublons
- `shared.rpc_manage_custom_fields(operation TEXT, field_data JSONB)` : Gestion champs personnalisés

Chaque fonction doit inclure validation des paramètres, gestion d'erreurs et audit des actions sensibles.

⚙️ **Interactions :** 
- Appelées par le frontend via packages/api-client
- Utilisent les politiques RLS pour la sécurité
- Intègrent avec Module Leads pour la conversion
- Loggent dans Console Admin pour l'audit

💡 **Tips Windsurf :** Structure les fonctions avec gestion d'erreurs robuste. Utilise des transactions pour les opérations complexes. Retourne des JSONB structurés pour faciliter le parsing frontend.

---

### 06 - Implémentation des triggers et automatisations

🎯 **But :** Automatiser les tâches répétitives et maintenir la cohérence des données avec des triggers PostgreSQL intelligents.

🧠 **Contexte technique :** Les triggers assurent la mise à jour automatique des timestamps, l'audit des modifications sensibles et la synchronisation avec les modules liés. Ils maintiennent l'intégrité des données sans intervention manuelle.

🛠️ **Type de fichier :** `.sql` (triggers PostgreSQL)

🔄 **Comportement attendu :**
Créer les triggers suivants :

**Triggers de maintenance :**
- `set_updated_at_clients` : Mise à jour automatique de `updated_at`
- `audit_client_changes` : Enregistrement dans `client_history` des modifications sensibles
- `validate_client_data` : Validation des données avant insertion/mise à jour

**Triggers de synchronisation :**
- `sync_client_portal_changes` : Notification des changements vers Client-Portal
- `update_related_modules` : Mise à jour des références dans modules liés
- `manage_user_profile_sync` : Synchronisation avec auth.users pour accès portal

**Triggers de nettoyage :**
- `cleanup_orphaned_documents` : Suppression des documents orphelins
- `archive_old_interactions` : Archivage automatique des anciennes interactions

⚙️ **Interactions :** 
- Synchronisation avec Client-Portal via Realtime
- Notification vers Dashboard pour mise à jour des métriques
- Intégration avec Console Admin pour l'audit

💡 **Tips Windsurf :** Utilise des triggers AFTER pour éviter les conflits. Implémente une logique de retry pour les synchronisations externes. Loggue les erreurs de triggers pour le debugging.

---

## 🚀 Section 2 : Fonctionnalités Principales


### 07 - Création de la page liste des clients

🎯 **But :** Développer l'interface principale de gestion des clients avec liste paginée, recherche avancée, filtres et actions en lot.

🧠 **Contexte technique :** Cette page est le point d'entrée principal du module. Elle doit gérer de gros volumes de données avec pagination côté serveur, recherche en temps réel et filtres multiples. L'interface utilise TanStack Query pour la gestion du cache et des états de chargement.

🛠️ **Type de fichier :** `.tsx` (React component)

🔄 **Comportement attendu :**
Créer `apps/backoffice/src/features/clients/pages/ClientListPage.tsx` avec :
- **Table responsive** avec colonnes : Nom complet, Email, Téléphone, Type, Source, Date création, Statut, Actions
- **Recherche globale** en temps réel avec debounce (nom, email, téléphone, entreprise)
- **Filtres avancés** : Type client, Source, Période de création, Statut actif/inactif
- **Pagination côté serveur** avec sélection du nombre d'éléments par page
- **Tri multi-colonnes** avec indicateurs visuels
- **Actions en lot** : Export, Suppression logique, Modification du statut
- **Actions individuelles** : Voir détails, Modifier, Supprimer, Créer événement
- **Indicateurs visuels** : Badges pour type client, icônes pour statut portal

Utiliser les composants ShadCN UI (Table, Input, Select, Button, Badge) et intégrer avec TanStack Query pour la gestion des données.

⚙️ **Interactions :** 
- Appelle `shared.rpc_get_clients_list()` via packages/api-client
- Navigation vers ClientDetailPage et ClientForm
- Intégration avec Module Événements pour création rapide
- Respect des permissions utilisateur depuis Console Admin

💡 **Tips Windsurf :** Utilise useDebounce pour la recherche. Implémente la virtualisation pour les grandes listes. Sauvegarde les filtres dans l'URL pour la navigation.

---

### 08 - Création du formulaire client (création/édition)

🎯 **But :** Développer le formulaire complet de création et d'édition des clients avec validation, gestion des erreurs et expérience utilisateur optimisée.

🧠 **Contexte technique :** Le formulaire gère les clients particuliers et entreprises avec des champs conditionnels. Il inclut la validation côté client avec Zod, la détection de doublons en temps réel et la gestion des champs personnalisés dynamiques.

🛠️ **Type de fichier :** `.tsx` (React component)

🔄 **Comportement attendu :**
Créer `apps/backoffice/src/features/clients/components/ClientForm.tsx` avec :

**Structure du formulaire :**
- **Onglet "Informations principales"** : Civilité, Nom, Prénom, Email, Téléphones
- **Onglet "Conjoint"** : Informations du client secondaire (conditionnel)
- **Onglet "Entreprise"** : Nom société, SIRET, TVA (si client B2B)
- **Onglet "Adresses"** : Adresse principale + adresses additionnelles
- **Onglet "Informations complémentaires"** : Type, Source, Langue, Notes
- **Onglet "Champs personnalisés"** : Rendu dynamique selon définitions

**Fonctionnalités avancées :**
- **Validation Zod** avec messages d'erreur contextuels
- **Détection de doublons** en temps réel sur email/nom
- **Auto-complétion** des adresses avec API géolocalisation
- **Upload de documents** avec drag & drop
- **Gestion des consentements RGPD** avec horodatage
- **Mode création depuis Lead** avec pré-remplissage

Utiliser React Hook Form avec Zod pour la validation et ShadCN UI pour les composants.

⚙️ **Interactions :** 
- Appelle `shared.rpc_create_client()` ou `shared.rpc_update_client()`
- Utilise `shared.rpc_get_client_similarity()` pour détection doublons
- Intégration avec Supabase Storage pour les documents
- Conversion depuis Module Leads via `shared.rpc_convert_lead_to_client()`

💡 **Tips Windsurf :** Utilise des schémas Zod conditionnels selon le type client. Implémente l'auto-save pour éviter la perte de données. Gère les états de chargement pour chaque section.

---

### 09 - Création de la page détails client

🎯 **But :** Développer la vue détaillée complète d'un client avec toutes les informations, documents, historique et données liées des autres modules.

🧠 **Contexte technique :** Cette page centralise toutes les informations client avec des onglets organisés. Elle affiche les données en lecture seule avec possibilité d'édition rapide. L'interface charge les données de manière optimisée avec des requêtes parallèles.

🛠️ **Type de fichier :** `.tsx` (React component)

🔄 **Comportement attendu :**
Créer `apps/backoffice/src/features/clients/pages/ClientDetailPage.tsx` avec :

**Onglets principaux :**
- **"Vue d'ensemble"** : Informations principales, statut, métriques clés
- **"Coordonnées"** : Toutes les informations de contact et adresses
- **"Documents"** : Liste des documents avec prévisualisation et téléchargement
- **"Interactions"** : Historique chronologique des communications
- **"Événements"** : Liste des événements liés avec statuts et dates
- **"Facturation"** : Devis, factures et paiements (lecture seule)
- **"Champs personnalisés"** : Affichage des valeurs avec possibilité d'édition
- **"Historique"** : Audit trail des modifications avec détails

**Fonctionnalités :**
- **Actions rapides** : Modifier, Créer événement, Ajouter interaction, Envoyer email
- **Widgets de synthèse** : CA total, Nombre d'événements, Dernière interaction
- **Timeline interactive** : Chronologie des événements et interactions
- **Accès Client-Portal** : Activation/désactivation avec génération de credentials

⚙️ **Interactions :** 
- Appelle `shared.rpc_get_client_details()` pour les données principales
- Intégration avec Module Événements pour affichage des événements
- Intégration avec Module Facturation pour les données financières
- Synchronisation avec Client-Portal pour l'accès client

💡 **Tips Windsurf :** Utilise Suspense pour le chargement progressif des onglets. Implémente le lazy loading pour les documents volumineux. Cache les données fréquemment consultées.

---

### 10 - Gestion des documents clients

🎯 **But :** Implémenter le système complet de gestion des documents clients avec upload, catégorisation, prévisualisation et partage sécurisé.

🧠 **Contexte technique :** Le système utilise Supabase Storage avec des buckets organisés par type de document. Les métadonnées sont stockées en base pour la recherche et la catégorisation. La sécurité est assurée par des politiques RLS sur le storage.

🛠️ **Type de fichier :** `.tsx` (React component)

🔄 **Comportement attendu :**
Créer `apps/backoffice/src/features/clients/components/ClientDocuments.tsx` avec :

**Interface de gestion :**
- **Zone de drop** pour upload multiple avec progress bars
- **Liste des documents** avec miniatures, métadonnées et actions
- **Filtres par type** : Contrats, Pièces d'identité, Briefs, Factures, Autres
- **Recherche textuelle** dans les noms et descriptions
- **Actions par document** : Télécharger, Prévisualiser, Modifier, Supprimer, Partager

**Fonctionnalités avancées :**
- **Prévisualisation intégrée** pour PDF, images et documents Office
- **Versioning automatique** avec historique des modifications
- **Partage sécurisé** avec liens temporaires et mots de passe
- **Visibilité Client-Portal** configurable par document
- **Validation des formats** et taille maximale
- **Compression automatique** des images

Utiliser react-dropzone pour l'upload et react-pdf pour la prévisualisation.

⚙️ **Interactions :** 
- Utilise Supabase Storage avec buckets `client-documents`
- Appelle `shared.rpc_get_client_documents()` pour les métadonnées
- Intégration avec Client-Portal pour la visibilité des documents
- Audit des accès via Console Admin

💡 **Tips Windsurf :** Implémente l'upload en chunks pour les gros fichiers. Utilise des workers pour la compression d'images. Gère les erreurs d'upload avec retry automatique.

---

### 11 - Système d'interactions et historique

🎯 **But :** Développer le système complet de suivi des interactions client avec saisie rapide, catégorisation et timeline chronologique.

🧠 **Contexte technique :** Le système enregistre tous les types d'interactions (appels, emails, réunions, notes) avec métadonnées structurées. L'interface permet la saisie rapide et l'affichage chronologique avec filtres avancés.

🛠️ **Type de fichier :** `.tsx` (React component)

🔄 **Comportement attendu :**
Créer `apps/backoffice/src/features/clients/components/ClientInteractions.tsx` avec :

**Interface de saisie :**
- **Formulaire rapide** : Type, Titre, Description, Date/Heure
- **Types d'interaction** : Appel entrant/sortant, Email, Réunion, Note, Changement statut
- **Métadonnées spécifiques** : Durée appel, Participants réunion, Pièces jointes email
- **Templates prédéfinis** pour les interactions courantes
- **Saisie vocale** avec transcription automatique (optionnel)

**Affichage timeline :**
- **Vue chronologique** avec groupement par jour/semaine/mois
- **Filtres par type** et période avec recherche textuelle
- **Icônes distinctives** par type d'interaction
- **Expansion/collapse** des détails avec métadonnées
- **Actions rapides** : Répondre, Planifier suivi, Marquer important

**Fonctionnalités avancées :**
- **Rappels automatiques** pour les suivis programmés
- **Intégration email** avec synchronisation des échanges
- **Statistiques d'interaction** par client et par période
- **Export des historiques** en PDF ou Excel

⚙️ **Interactions :** 
- Appelle `shared.rpc_add_client_interaction()` pour l'ajout
- Intégration avec système de notifications pour les rappels
- Synchronisation avec Client-Portal pour les interactions client
- Liaison avec Module Événements pour les interactions liées

💡 **Tips Windsurf :** Utilise des formulaires modaux pour la saisie rapide. Implémente la pagination virtuelle pour les longues timelines. Sauvegarde automatiquement les brouillons.

---

### 12 - Conversion Lead vers Client

🎯 **But :** Implémenter le processus automatisé de conversion des leads qualifiés en clients avec transfert des données et workflow de validation.

🧠 **Contexte technique :** La conversion transfère toutes les données du lead vers le client en préservant l'historique. Le processus inclut la validation des données, la détection de doublons et la mise à jour des statuts dans les deux modules.

🛠️ **Type de fichier :** `.tsx` (React component)

🔄 **Comportement attendu :**
Créer `apps/backoffice/src/features/clients/components/LeadConversion.tsx` avec :

**Interface de conversion :**
- **Sélection du lead** avec recherche et filtres (statut qualifié uniquement)
- **Prévisualisation des données** à transférer avec possibilité de modification
- **Détection de doublons** avec suggestions de fusion ou création
- **Mapping des champs** lead vers client avec validation
- **Choix des éléments** à transférer (interactions, documents, tâches)

**Processus de validation :**
- **Vérification des données** obligatoires manquantes
- **Validation des formats** (email, téléphone, adresses)
- **Contrôle de cohérence** avec les données existantes
- **Confirmation utilisateur** avec récapitulatif des actions

**Post-conversion :**
- **Mise à jour automatique** du statut lead vers "Converti"
- **Création du lien** `converted_from_lead_id` dans la table clients
- **Transfert de l'historique** avec préservation des timestamps
- **Notification automatique** aux équipes concernées

⚙️ **Interactions :** 
- Appelle `shared.rpc_convert_lead_to_client()` pour la conversion
- Intégration avec Module Leads pour mise à jour des statuts
- Utilise `shared.rpc_get_client_similarity()` pour détection doublons
- Notification via Dashboard des conversions réussies

💡 **Tips Windsurf :** Utilise des transactions pour garantir la cohérence. Implémente un système de rollback en cas d'erreur. Loggue toutes les étapes pour l'audit.

---

## 🔧 Section 3 : Fonctionnalités Secondaires


### 13 - Gestion des champs personnalisés

🎯 **But :** Implémenter le système complet de champs personnalisés permettant aux organisations d'adapter les fiches clients à leurs besoins spécifiques.

🧠 **Contexte technique :** Le système utilise une approche EAV (Entity-Attribute-Value) avec des tables dédiées pour les définitions et valeurs. Les champs sont typés (texte, nombre, date, booléen, liste) avec validation dynamique côté client et serveur.

🛠️ **Type de fichier :** `.tsx` (React component)

🔄 **Comportement attendu :**
Créer `apps/backoffice/src/features/clients/components/CustomFields.tsx` avec :

**Gestion des définitions :**
- **Interface d'administration** pour créer/modifier les définitions de champs
- **Types supportés** : Texte, Nombre, Date, Booléen, Liste déroulante, Multi-sélection
- **Configuration avancée** : Obligatoire, Valeur par défaut, Validation personnalisée
- **Visibilité Client-Portal** : Configurable par champ (visible/éditable)
- **Ordre d'affichage** avec drag & drop pour réorganisation

**Rendu dynamique :**
- **Composants adaptatifs** selon le type de champ défini
- **Validation en temps réel** avec messages d'erreur contextuels
- **Auto-complétion** pour les champs texte avec historique
- **Formatage automatique** pour les nombres et dates
- **Gestion des dépendances** entre champs (affichage conditionnel)

**Interface utilisateur :**
- **Groupement logique** des champs par catégories
- **Recherche et filtres** sur les champs personnalisés
- **Import/export** des définitions entre organisations
- **Historique des modifications** avec audit trail complet

⚙️ **Interactions :** 
- Utilise `shared.custom_field_definitions` et `shared.client_custom_fields`
- Appelle `shared.rpc_manage_custom_fields()` pour les opérations CRUD
- Synchronisation avec Client-Portal pour les champs éditables
- Intégration avec Console Admin pour les permissions de gestion

💡 **Tips Windsurf :** Utilise des composants génériques pour le rendu des champs. Implémente la validation côté serveur pour la sécurité. Cache les définitions pour optimiser les performances.

---

### 14 - Détection et gestion des doublons

🎯 **But :** Développer un système intelligent de détection et de gestion des doublons clients avec algorithmes de similarité et interface de fusion.

🧠 **Contexte technique :** Le système utilise des algorithmes de similarité (Levenshtein, Soundex) pour détecter les doublons potentiels sur nom, email, téléphone et adresse. L'interface permet la comparaison visuelle et la fusion sélective des données.

🛠️ **Type de fichier :** `.tsx` (React component)

🔄 **Comportement attendu :**
Créer `apps/backoffice/src/features/clients/components/DuplicateDetection.tsx` avec :

**Détection automatique :**
- **Scan périodique** de la base clients avec scoring de similarité
- **Algorithmes multiples** : Similarité textuelle, phonétique, géographique
- **Seuils configurables** pour les différents niveaux de correspondance
- **Détection en temps réel** lors de la création/modification
- **Exclusions manuelles** pour éviter les faux positifs récurrents

**Interface de gestion :**
- **Liste des doublons** détectés avec scores de confiance
- **Comparaison côte à côte** des fiches suspectes
- **Fusion sélective** : Choix des champs à conserver de chaque fiche
- **Préservation de l'historique** : Fusion des interactions et documents
- **Validation manuelle** avant fusion définitive

**Fonctionnalités avancées :**
- **Règles personnalisées** de détection par organisation
- **Machine learning** pour améliorer la précision au fil du temps
- **Rapports de qualité** des données avec métriques de doublons
- **API de vérification** pour les intégrations externes

⚙️ **Interactions :** 
- Appelle `shared.rpc_get_client_similarity()` pour la détection
- Utilise des fonctions de fusion pour préserver l'intégrité
- Intégration avec Console Admin pour l'audit des fusions
- Notification des équipes lors de détections importantes

💡 **Tips Windsurf :** Utilise des workers pour les calculs intensifs. Implémente des sauvegardes avant fusion. Optimise les algorithmes pour les gros volumes.

---

### 15 - Import/Export de données clients

🎯 **But :** Développer un système robuste d'import/export pour la migration de données et l'intégration avec des systèmes externes.

🧠 **Contexte technique :** Le système supporte multiple formats (CSV, Excel, JSON) avec mapping flexible des colonnes. L'import inclut la validation, la détection de doublons et la gestion d'erreurs avec rapports détaillés.

🛠️ **Type de fichier :** `.tsx` (React component)

🔄 **Comportement attendu :**
Créer `apps/backoffice/src/features/clients/components/ImportExport.tsx` avec :

**Import de données :**
- **Support multi-formats** : CSV, Excel (.xlsx), JSON
- **Mapping interactif** des colonnes source vers champs destination
- **Prévisualisation** des données avec détection automatique des types
- **Validation en lot** avec rapport d'erreurs détaillé
- **Mode simulation** pour tester l'import sans modification
- **Import incrémental** avec gestion des mises à jour

**Export de données :**
- **Sélection flexible** : Tous clients, filtres personnalisés, sélection manuelle
- **Formats de sortie** : CSV, Excel, JSON, PDF (fiches complètes)
- **Personnalisation** des colonnes et de l'ordre d'export
- **Chiffrement** des exports sensibles avec mot de passe
- **Planification** d'exports automatiques récurrents

**Gestion des erreurs :**
- **Validation ligne par ligne** avec messages contextuels
- **Correction assistée** des erreurs communes
- **Import partiel** : Traitement des lignes valides, rapport des erreurs
- **Rollback complet** en cas d'erreur critique
- **Logs détaillés** pour traçabilité et debugging

⚙️ **Interactions :** 
- Utilise les fonctions RPC pour validation et insertion en lot
- Intégration avec Supabase Storage pour fichiers temporaires
- Appelle la détection de doublons pendant l'import
- Audit complet via Console Admin

💡 **Tips Windsurf :** Utilise des streams pour les gros fichiers. Implémente la validation côté serveur pour la sécurité. Optimise les insertions en lot avec transactions.

---

### 16 - Analytics et rapports clients

🎯 **But :** Créer un système complet d'analytics et de rapports pour analyser les données clients et optimiser les processus commerciaux.

🧠 **Contexte technique :** Le système génère des métriques en temps réel avec des requêtes optimisées. Les rapports sont interactifs avec filtres dynamiques et export en multiple formats. L'interface utilise des graphiques responsives.

🛠️ **Type de fichier :** `.tsx` (React component)

🔄 **Comportement attendu :**
Créer `apps/backoffice/src/features/clients/components/ClientAnalytics.tsx` avec :

**Métriques principales :**
- **KPIs globaux** : Nombre total clients, Croissance mensuelle, Taux de conversion leads
- **Répartition par type** : Particuliers vs Entreprises, Sources d'acquisition
- **Analyse géographique** : Répartition par région, ville, pays
- **Analyse temporelle** : Évolution des inscriptions, Saisonnalité
- **Qualité des données** : Complétude des fiches, Doublons détectés

**Rapports interactifs :**
- **Tableaux de bord** personnalisables avec widgets drag & drop
- **Filtres dynamiques** : Période, Type, Source, Statut, Région
- **Drill-down** : Navigation des vues globales vers le détail
- **Comparaisons** : Périodes, Segments, Équipes commerciales
- **Alertes automatiques** : Seuils personnalisables avec notifications

**Visualisations :**
- **Graphiques temporels** : Évolution des inscriptions, Activité
- **Graphiques sectoriels** : Répartition par type, source, région
- **Cartes géographiques** : Densité clients par zone
- **Heatmaps** : Activité par jour/heure, Saisonnalité
- **Funnels** : Conversion leads vers clients

Utiliser Recharts ou Chart.js pour les visualisations.

⚙️ **Interactions :** 
- Requêtes optimisées sur les tables clients avec agrégations
- Intégration avec Module Leads pour métriques de conversion
- Données temps réel via Supabase Realtime
- Export vers Dashboard principal pour supervision globale

💡 **Tips Windsurf :** Utilise des vues matérialisées pour les calculs complexes. Implémente le cache pour les métriques fréquentes. Optimise les requêtes avec des index appropriés.

---

### 17 - Intégration Client-Portal

🎯 **But :** Développer l'intégration complète avec le Client-Portal pour la synchronisation bidirectionnelle des données et la gestion des accès clients.

🧠 **Contexte technique :** L'intégration utilise Supabase Realtime pour la synchronisation temps réel et des API dédiées pour les modifications. Le système gère les conflits de données et les permissions granulaires.

🛠️ **Type de fichier :** `.tsx` (React component)

🔄 **Comportement attendu :**
Créer `apps/backoffice/src/features/clients/components/PortalIntegration.tsx` avec :

**Gestion des accès :**
- **Activation/désactivation** de l'accès Client-Portal par client
- **Génération automatique** des credentials avec envoi sécurisé
- **Gestion des permissions** : Lecture seule, Édition limitée, Accès complet
- **Réinitialisation** des mots de passe avec liens temporaires
- **Audit des connexions** avec logs détaillés

**Synchronisation des données :**
- **Modifications temps réel** : Notification des changements côté client
- **Gestion des conflits** : Interface de résolution avec historique
- **Validation des modifications** : Workflow d'approbation pour changements sensibles
- **Rollback automatique** en cas d'erreur de synchronisation
- **Queue de synchronisation** pour les modifications hors ligne

**Interface de supervision :**
- **Statut de synchronisation** par client avec indicateurs visuels
- **Modifications en attente** avec interface d'approbation/rejet
- **Historique des synchronisations** avec détails des erreurs
- **Métriques d'utilisation** du portal par client
- **Configuration des notifications** pour les équipes

⚙️ **Interactions :** 
- Utilise Supabase Realtime pour synchronisation temps réel
- Intégration avec auth.users pour gestion des comptes
- Appelle les fonctions RPC pour validation des modifications
- Coordination avec Console Admin pour permissions et audit

💡 **Tips Windsurf :** Implémente des queues pour la synchronisation asynchrone. Utilise des websockets pour les notifications temps réel. Gère les timeouts et reconnexions automatiques.

---

### 18 - Gestion des consentements RGPD

🎯 **But :** Implémenter un système complet de gestion des consentements RGPD avec traçabilité, révocation et conformité réglementaire.

🧠 **Contexte technique :** Le système enregistre tous les consentements avec horodatage précis et source. Il gère les différents types de consentements (traitement, marketing, partage) avec possibilité de révocation granulaire.

🛠️ **Type de fichier :** `.tsx` (React component)

🔄 **Comportement attendu :**
Créer `apps/backoffice/src/features/clients/components/GDPRConsents.tsx` avec :

**Types de consentements :**
- **Traitement des données** : Obligatoire pour la création du compte
- **Communications marketing** : Optionnel avec granularité (email, SMS, courrier)
- **Partage avec partenaires** : Optionnel avec liste des partenaires
- **Cookies et tracking** : Granulaire par catégorie de cookies
- **Conservation des données** : Durée et conditions de conservation

**Interface de gestion :**
- **Statut visuel** des consentements avec codes couleur
- **Historique complet** : Dates, sources, modifications, révocations
- **Formulaires de consentement** intégrés avec validation légale
- **Révocation facilitée** avec confirmation et effet immédiat
- **Export des preuves** pour audits et contrôles réglementaires

**Conformité réglementaire :**
- **Textes légaux** configurables par organisation et juridiction
- **Preuves horodatées** avec signature numérique
- **Alertes d'expiration** pour les consentements temporaires
- **Rapports de conformité** avec métriques détaillées
- **Intégration DPO** : Notifications pour les demandes de suppression

⚙️ **Interactions :** 
- Stockage sécurisé dans `consent_details` JSONB avec audit
- Intégration avec Client-Portal pour gestion autonome
- Synchronisation avec outils marketing pour respect des préférences
- Reporting vers Console Admin pour supervision légale

💡 **Tips Windsurf :** Utilise des signatures cryptographiques pour l'intégrité. Implémente l'immutabilité des enregistrements de consentement. Automatise les rappels de renouvellement.

---

## 🚀 Section 4 : Évolutions Futures


### 19 - Intelligence artificielle pour recommandations clients

🎯 **But :** Intégrer des capacités d'IA pour fournir des recommandations intelligentes sur la gestion client et l'optimisation des processus.

🧠 **Contexte technique :** Le système utilise l'apprentissage automatique pour analyser les patterns de comportement client et suggérer des actions optimales. L'IA s'appuie sur l'historique des interactions et les données des autres modules.

🛠️ **Type de fichier :** `.tsx` + `.py` (Edge Functions)

🔄 **Comportement attendu :**
Développer un système d'IA avec :

**Recommandations personnalisées :**
- **Prédiction de churn** : Identification des clients à risque de départ
- **Opportunités d'upselling** : Suggestions de services additionnels
- **Timing optimal** : Meilleurs moments pour contacter chaque client
- **Personnalisation** : Adaptation des communications selon le profil
- **Scoring de satisfaction** : Prédiction du niveau de satisfaction

**Automatisation intelligente :**
- **Catégorisation automatique** des nouveaux clients
- **Détection d'anomalies** dans les comportements clients
- **Suggestions de champs personnalisés** basées sur les patterns
- **Optimisation des workflows** selon l'efficacité mesurée
- **Prédiction de conversion** pour les leads entrants

**Interface utilisateur :**
- **Dashboard IA** avec insights et recommandations
- **Alertes proactives** pour actions recommandées
- **Explications** des recommandations avec facteurs d'influence
- **Feedback loop** pour améliorer les prédictions
- **Configuration** des seuils et paramètres IA

⚙️ **Interactions :** 
- Intégration avec Console IA pour les modèles d'apprentissage
- Utilise les données de tous les modules pour l'entraînement
- API externes pour enrichissement des données
- Supabase Edge Functions pour les calculs IA

💡 **Tips Windsurf :** Utilise des modèles pré-entraînés pour démarrer rapidement. Implémente l'apprentissage incrémental. Assure la transparence des décisions IA.

---

### 20 - Intégration CRM externe

🎯 **But :** Développer des connecteurs pour synchroniser les données clients avec les CRM externes populaires (Salesforce, HubSpot, Pipedrive).

🧠 **Contexte technique :** Le système utilise des APIs REST et webhooks pour la synchronisation bidirectionnelle. Les mappings de champs sont configurables et les conflits sont gérés automatiquement.

🛠️ **Type de fichier :** `.ts` (Services d'intégration)

🔄 **Comportement attendu :**
Créer des connecteurs pour :

**CRM supportés :**
- **Salesforce** : Synchronisation complète avec objets personnalisés
- **HubSpot** : Intégration contacts et deals avec propriétés custom
- **Pipedrive** : Sync personnes et organisations avec champs additionnels
- **Zoho CRM** : Mapping flexible avec modules personnalisés
- **API générique** : Connecteur configurable pour autres CRM

**Fonctionnalités de synchronisation :**
- **Mapping intelligent** des champs avec suggestions automatiques
- **Synchronisation bidirectionnelle** avec résolution de conflits
- **Sync incrémentale** pour optimiser les performances
- **Webhooks** pour synchronisation temps réel
- **Queue de retry** pour gérer les erreurs temporaires

**Interface de configuration :**
- **Assistant de configuration** step-by-step pour chaque CRM
- **Test de connexion** avec validation des credentials
- **Mapping visuel** des champs avec prévisualisation
- **Planification** des synchronisations avec monitoring
- **Logs détaillés** des synchronisations avec gestion d'erreurs

⚙️ **Interactions :** 
- Utilise les fonctions RPC pour validation et insertion
- Intégration avec Console Admin pour configuration et monitoring
- Coordination avec Module Leads pour synchronisation complète
- Audit complet des synchronisations

💡 **Tips Windsurf :** Implémente des rate limits pour respecter les quotas API. Utilise des queues pour les synchronisations en lot. Gère les différences de timezone entre systèmes.

---

### 21 - Application mobile dédiée

🎯 **But :** Développer une application mobile native pour la gestion clients en mobilité avec fonctionnalités offline et synchronisation.

🧠 **Contexte technique :** L'application utilise React Native avec Expo pour le développement cross-platform. Elle inclut la synchronisation offline avec SQLite local et sync automatique lors de la reconnexion.

🛠️ **Type de fichier :** `.tsx` (React Native)

🔄 **Comportement attendu :**
Développer une app mobile avec :

**Fonctionnalités core :**
- **Liste clients** optimisée pour mobile avec recherche rapide
- **Fiches clients** complètes avec navigation intuitive
- **Ajout d'interactions** rapide avec templates prédéfinis
- **Prise de photos** pour documents avec upload automatique
- **Géolocalisation** pour visites clients avec tracking

**Fonctionnalités offline :**
- **Cache intelligent** des clients fréquemment consultés
- **Synchronisation différée** des modifications offline
- **Résolution de conflits** automatique avec interface de choix
- **Indicateurs visuels** du statut de synchronisation
- **Mode dégradé** avec fonctionnalités essentielles

**Optimisations mobiles :**
- **Interface tactile** optimisée avec gestes intuitifs
- **Performance** : Lazy loading et virtualisation
- **Notifications push** pour rappels et alertes importantes
- **Intégration native** : Contacts, Calendrier, Téléphone
- **Sécurité renforcée** : Biométrie, chiffrement local

⚙️ **Interactions :** 
- API dédiée avec endpoints optimisés pour mobile
- Synchronisation avec Supabase via API REST
- Push notifications via services natifs
- Intégration avec calendriers et contacts du device

💡 **Tips Windsurf :** Utilise Expo pour simplifier le développement. Implémente la synchronisation en arrière-plan. Optimise la consommation de batterie.

---

### 22 - Blockchain pour traçabilité

🎯 **But :** Implémenter une solution blockchain pour assurer la traçabilité immuable des données clients et des consentements RGPD.

🧠 **Contexte technique :** Le système utilise une blockchain privée ou consortium pour enregistrer les hash des modifications importantes. Cela garantit l'intégrité des données sans exposer les informations sensibles.

🛠️ **Type de fichier :** `.ts` (Smart contracts et services)

🔄 **Comportement attendu :**
Développer une solution blockchain avec :

**Architecture blockchain :**
- **Blockchain privée** ou consortium pour contrôle des accès
- **Smart contracts** pour validation automatique des transactions
- **Hash des données** sensibles sans exposition du contenu
- **Consensus** entre nœuds pour validation des modifications
- **Immutabilité** garantie pour l'audit et la conformité

**Cas d'usage prioritaires :**
- **Consentements RGPD** : Preuve immuable des consentements
- **Modifications sensibles** : Audit trail inaltérable
- **Transferts de données** : Traçabilité des partages
- **Certifications** : Validation de l'authenticité des documents
- **Compliance** : Preuves pour audits réglementaires

**Interface utilisateur :**
- **Visualisation** de la chaîne de traçabilité
- **Vérification** de l'intégrité des données
- **Certificats** de conformité générés automatiquement
- **Alertes** en cas de tentative de modification non autorisée
- **Rapports** de conformité avec preuves blockchain

⚙️ **Interactions :** 
- Intégration avec les triggers de base de données
- API pour vérification d'intégrité
- Services de hachage cryptographique
- Interface avec autorités de certification

💡 **Tips Windsurf :** Commence par une blockchain de test. Utilise des hash pour préserver la confidentialité. Implémente des mécanismes de backup pour la résilience.

---

### 23 - Intégration IoT pour événements

🎯 **But :** Développer l'intégration avec des dispositifs IoT pour enrichir automatiquement les données clients lors des événements.

🧠 **Contexte technique :** Le système collecte des données depuis des capteurs IoT (présence, température, son) lors des événements pour analyser la satisfaction client et optimiser les services.

🛠️ **Type de fichier :** `.ts` (Services IoT)

🔄 **Comportement attendu :**
Créer un système IoT avec :

**Capteurs supportés :**
- **Capteurs de présence** : Comptage et flux des invités
- **Capteurs environnementaux** : Température, humidité, qualité air
- **Capteurs audio** : Niveau sonore et ambiance musicale
- **Capteurs visuels** : Analyse des expressions et engagement
- **Beacons Bluetooth** : Tracking des déplacements et interactions

**Collecte et analyse :**
- **Agrégation temps réel** des données multi-capteurs
- **Corrélation** avec les événements clients en cours
- **Détection d'anomalies** et alertes automatiques
- **Analytics prédictifs** pour optimisation des futurs événements
- **Rapports automatisés** de satisfaction basés sur les métriques

**Interface de monitoring :**
- **Dashboard temps réel** des métriques IoT par événement
- **Alertes proactives** pour intervention rapide
- **Historique** des métriques avec corrélation satisfaction
- **Configuration** des seuils et paramètres par type d'événement
- **Intégration** avec les fiches clients pour enrichissement

⚙️ **Interactions :** 
- Intégration avec Module Événements pour corrélation
- Enrichissement automatique des fiches clients
- API pour dispositifs IoT tiers
- Analytics pour optimisation des services

💡 **Tips Windsurf :** Utilise des protocoles IoT standards (MQTT, CoAP). Implémente la gestion des pannes de capteurs. Assure la sécurité des communications IoT.

---

### 24 - Réalité augmentée pour visualisation

🎯 **But :** Développer des fonctionnalités de réalité augmentée pour enrichir l'expérience client et améliorer la présentation des services.

🧠 **Contexte technique :** Le système utilise WebXR et des frameworks AR pour créer des expériences immersives accessibles depuis navigateur et applications mobiles.

🛠️ **Type de fichier :** `.tsx` + `.js` (WebXR)

🔄 **Comportement attendu :**
Créer des expériences AR avec :

**Cas d'usage clients :**
- **Visualisation 3D** des lieux de réception avec personnalisation
- **Essayage virtuel** de décorations et aménagements
- **Présentation immersive** des services avec modèles 3D
- **Visite virtuelle** des lieux avec annotations interactives
- **Simulation** des événements avec différentes configurations

**Fonctionnalités techniques :**
- **Reconnaissance d'objets** pour ancrage AR précis
- **Tracking spatial** pour stabilité des éléments virtuels
- **Interaction gestuelle** pour manipulation des objets 3D
- **Partage d'expérience** multi-utilisateurs en temps réel
- **Capture et sauvegarde** des configurations personnalisées

**Interface utilisateur :**
- **Launcher AR** intégré aux fiches clients
- **Bibliothèque d'assets** 3D organisée par catégories
- **Éditeur visuel** pour création de scènes personnalisées
- **Galerie** des expériences sauvegardées par client
- **Analytics** d'engagement et préférences AR

⚙️ **Interactions :** 
- Intégration avec Module Lieux pour modèles 3D
- Enrichissement des fiches clients avec préférences AR
- Stockage des assets 3D dans Supabase Storage
- Analytics d'utilisation pour optimisation

💡 **Tips Windsurf :** Commence par WebXR pour compatibilité cross-platform. Optimise les modèles 3D pour performance mobile. Implémente des fallbacks pour devices non-AR.

---

## 📊 Matrice de Priorités et Recommandations d'Exécution

### **Phase 1 - Infrastructure Critique (Semaines 1-2)**
**Prompts 01-06** : Fondations base de données et API
- Priorité P0 : Création schéma, types, index, RLS, RPC, triggers
- Dépendances : Console Admin, Module Leads
- Validation : Tests unitaires des fonctions RPC

### **Phase 2 - Interfaces Principales (Semaines 3-5)**
**Prompts 07-12** : Interfaces utilisateur core
- Priorité P1 : Liste clients, formulaire, détails, documents, interactions, conversion
- Dépendances : Packages shared-ui, api-client
- Validation : Tests d'intégration et UX

### **Phase 3 - Fonctionnalités Avancées (Semaines 6-8)**
**Prompts 13-18** : Fonctionnalités secondaires
- Priorité P2 : Champs personnalisés, doublons, import/export, analytics, portal, RGPD
- Dépendances : Client-Portal, Console IA
- Validation : Tests de performance et sécurité

### **Phase 4 - Évolutions Futures (Versions ultérieures)**
**Prompts 19-24** : Innovations technologiques
- Priorité P3 : IA, CRM, mobile, blockchain, IoT, AR
- Dépendances : Technologies émergentes, budget R&D
- Validation : POC et validation marché

---

## 🎯 Recommandations Finales

### **Criticité du Module**
Le module Clients est **P0 CRITIQUE** - il constitue le cœur de la gestion client et alimente tous les autres modules métier. Sa réussite conditionne l'efficacité globale de l'ERP.

### **Intégrations Prioritaires**
1. **Module Leads** : Conversion automatisée essentielle
2. **Console Admin** : Sécurité et permissions critiques  
3. **Client-Portal** : Synchronisation bidirectionnelle stratégique
4. **Module Événements** : Liaison métier fondamentale

### **Points de Vigilance**
- **Complexité des données** : 8 tables interconnectées nécessitent une coordination précise
- **Performance** : Optimisation requise pour recherches et jointures complexes
- **Sécurité RGPD** : Conformité réglementaire stricte obligatoire
- **Synchronisation** : Gestion des conflits Client-Portal critique

### **Facteurs de Succès**
- **Formation utilisateur** : Interface complexe nécessitant accompagnement
- **Migration données** : Planification soigneuse depuis systèmes existants
- **Tests de charge** : Validation avec volumes réalistes
- **Monitoring continu** : Surveillance performance et adoption

---

*Ce module Clients constitue le cœur métier de l'ERP Wedding Collection. Son implémentation réussie garantira une gestion client optimale et une base solide pour tous les modules connexes.*

